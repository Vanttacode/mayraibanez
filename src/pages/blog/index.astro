---
export const prerender = false;

import MobileAppLayout from "@/layouts/MobileAppLayout.astro";
import { supabaseServer } from "@/lib/supabaseServer";
import { SITE_HANDLE } from "@/lib/site";

/* Perfil */
const { data: dbProfile } = await supabaseServer
  .from("profiles")
  .select("*")
  .eq("handle", SITE_HANDLE)
  .single();

if (!dbProfile) throw new Error("Perfil no encontrado");

/* Override (consistencia con el index) */
const profile = {
  ...(dbProfile || {}),
  display_name: "Mayra Ib√°√±ez",
  email: "mayraibanezcontacto@gmail.com",
};

/* Posts publicados */
const { data: posts } = await supabaseServer
  .from("posts")
  .select("id, user_id, title, slug, excerpt, cover_url, published_at, created_at")
  .eq("user_id", dbProfile.id)
  .not("published_at", "is", null)
  .order("published_at", { ascending: false });

const list = posts ?? [];
---

<MobileAppLayout title={`√öltimas Noticias ¬∑ ${profile.display_name}`} description="√öltimas noticias y novedades">
  
  {/* Fondo limpio y moderno */}
  <div class="fixed inset-0 z-0 bg-slate-50 pointer-events-none"></div>

  <div class="relative z-10 space-y-6 pt-4 pb-12 px-4 md:px-6 max-w-2xl mx-auto">
    
    {/* Header Minimalista */}
    <header class="flex items-center justify-between">
      <a 
        href="/" 
        class="group flex items-center gap-2 px-5 py-2.5 rounded-full bg-white shadow-sm border border-slate-200 text-slate-600 font-medium text-sm hover:border-pink-300 hover:text-pink-500 transition-all"
      >
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
        <span>Volver</span>
      </a>
      
      <div class="bg-white px-4 py-2 rounded-full shadow-sm border border-slate-100">
        <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Feed</span>
      </div>
    </header>

    {/* T√≠tulo de Secci√≥n */}
    <section class="text-center py-6">
      <h1 class="text-4xl md:text-5xl font-extrabold text-pink-500 tracking-tight mb-3">
        √öltimas Noticias
      </h1>
      
      <p class="text-sm text-slate-500 font-medium max-w-[280px] mx-auto leading-relaxed">
        Novedades, actualizaciones y todo lo que necesitas saber. ‚ú®
      </p>
    </section>

    {/* Lista de Noticias */}
    <section class="space-y-5">
      {list.length === 0 ? (
        <div class="flex flex-col items-center justify-center py-16 px-6 bg-white rounded-[2rem] border border-dashed border-slate-200 shadow-sm text-center">
          <div class="mb-4 bg-slate-50 p-4 rounded-2xl text-pink-400">
            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
          </div>
          <p class="text-slate-700 font-bold text-lg">A√∫n no hay noticias.</p>
          <p class="text-sm text-slate-500 mt-1 font-medium">¬°Pronto subir√© novedades! üíï</p>
        </div>
      ) : (
        list.map((p) => (
          <a
            href={`/blog/${p.slug}`}
            class="group relative flex flex-col sm:flex-row gap-4 sm:gap-5 rounded-[2rem] bg-white p-4 shadow-[0_4px_20px_rgb(0,0,0,0.03)] border border-slate-100 hover:shadow-[0_8px_30px_rgb(236,72,153,0.12)] hover:-translate-y-1 hover:border-pink-200 transition-all duration-300 overflow-hidden"
          >
            {/* Imagen / Cover */}
            <div class="shrink-0 relative w-full sm:w-auto">
              {p.cover_url ? (
                <img
                  src={p.cover_url}
                  class="h-48 sm:h-32 w-full sm:w-32 rounded-[1.5rem] object-cover bg-slate-50 group-hover:scale-[1.03] transition-transform duration-500"
                  alt={p.title}
                  loading="lazy"
                  decoding="async"
                />
              ) : (
                <div class="h-48 sm:h-32 w-full sm:w-32 rounded-[1.5rem] bg-slate-50 border border-slate-100 flex items-center justify-center text-slate-300">
                   <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>
                </div>
              )}
            </div>

            {/* Contenido */}
            <div class="min-w-0 flex-1 py-1 flex flex-col justify-center">
              <div class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-2 flex items-center gap-1.5">
                 <span class="w-1.5 h-1.5 rounded-full bg-pink-400"></span>
                 {new Date(p.published_at ?? p.created_at).toLocaleDateString("es-CL", { day: 'numeric', month: 'short', year: 'numeric' })}
              </div>
              
              {/* T√çTULO EN ROSA */}
              <h2 class="font-bold text-pink-500 text-xl sm:text-lg leading-tight mb-2 group-hover:text-pink-600 transition-colors line-clamp-2">
                  {p.title}
              </h2>
              
              <p class="text-sm sm:text-xs text-slate-500 line-clamp-2 font-medium leading-relaxed">
                  {p.excerpt}
              </p>
            </div>
            
            {/* Flecha (Visible en Hover en desktop) */}
            <div class="hidden sm:flex absolute bottom-4 right-4 opacity-0 -translate-x-2 group-hover:opacity-100 group-hover:translate-x-0 transition-all duration-300 text-pink-500 bg-pink-50 rounded-full p-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>
            </div>
          </a>
        ))
      )}
    </section>

    {/* Footer Elegante */}
    <footer class="pt-10 pb-6">
      <div class="rounded-[2.5rem] bg-white border border-slate-100 p-8 text-center shadow-sm">
  

        <a href="/ingreso-admin" class="mt-6 block text-[10px] text-slate-400 font-bold hover:text-pink-500 transition uppercase tracking-widest">
          Acceso Administrador
        </a>
      </div>
    </footer>
  </div>
</MobileAppLayout>