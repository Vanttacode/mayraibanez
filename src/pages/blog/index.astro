---
export const prerender = false;

import MobileAppLayout from "@/layouts/MobileAppLayout.astro";
import { supabaseServer } from "@/lib/supabaseServer";
import { SITE_HANDLE } from "@/lib/site";

const { data: profile } = await supabaseServer
  .from("profiles")
  .select("*")
  .eq("handle", SITE_HANDLE)
  .single();

if (!profile) throw new Error("Perfil no encontrado");

const { data: posts } = await supabaseServer
  .from("posts")
  .select("id, user_id, title, slug, excerpt, cover_url, published_at, created_at")
  .eq("user_id", profile.id)
  .not("published_at", "is", null)
  .order("published_at", { ascending: false });

const list = posts ?? [];
---

<MobileAppLayout title={`Blog · ${profile.display_name}`} description="Mini blog">
  <div class="space-y-3">
    <header class="flex items-center justify-between">
      <a href="/" class="text-sm text-white/70 hover:text-white">← Volver</a>
      <a href="/admin" class="text-sm text-white/70 hover:text-white">Admin</a>
    </header>

    <section class="rounded-3xl border border-white/10 bg-white/5 p-4">
      <h1 class="text-lg font-bold">Mini Blog</h1>
      <p class="text-sm text-white/60">Entradas cortas, tipo diario o updates.</p>
    </section>

    <section class="space-y-2">
      {list.length === 0 ? (
        <div class="rounded-3xl border border-white/10 bg-white/5 p-4 text-sm text-white/60">
          No hay entradas publicadas todavía.
        </div>
      ) : (
        list.map((p) => (
          <a
            href={`/blog/${p.slug}`}
            class="block rounded-3xl border border-white/10 bg-white/5 p-4 hover:bg-white/10 transition"
          >
            <div class="flex gap-3">
              {p.cover_url ? (
                <img src={p.cover_url} class="h-16 w-16 rounded-2xl object-cover border border-white/10" alt="" loading="lazy" />
              ) : (
                <div class="h-16 w-16 rounded-2xl bg-white/5 border border-white/10" />
              )}
              <div class="min-w-0">
                <div class="font-semibold truncate">{p.title}</div>
                <div class="text-sm text-white/60 line-clamp-2">{p.excerpt}</div>
                <div class="text-xs text-white/45 mt-1">
                  {new Date(p.published_at ?? p.created_at).toLocaleDateString("es-CL")}
                </div>
              </div>
            </div>
          </a>
        ))
      )}
    </section>
  </div>
</MobileAppLayout>
